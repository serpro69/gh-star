---
# GitHub Actions Workflow responsible for cleaning up the Claude Starter Kit Template repository from
# the template-specific files and configurations. This workflow is supposed to be triggered manually by the user
# after a new template-based repository has been created.

name: Template Cleanup
on:
  workflow_dispatch:
    inputs:
      LANGUAGE:
        description: |
          Primary programming language(s) of this project.
          Used for Serena semantic analysis (e.g., "python", "typescript", "java").
          See Serena docs for supported languages.
        required: false
        default: ''
        type: string
      SERENA_INITIAL_PROMPT:
        description: Initial prompt/context for Serena semantic analysis.
        required: false
        default: ''
        type: string
      TM_CUSTOM_SYSTEM_PROMPT:
        description: Custom system prompt to override Claude Code default behavior in Task Master.
        required: false
        default: ''
        type: string
      TM_APPEND_SYSTEM_PROMPT:
        description: Additional content to append to Claude Code system prompt in Task Master.
        required: false
        default: ''
        type: string
      TM_PERMISSION_MODE:
        description: Task Master permission mode for file system operations.
        required: false
        default: default
        type: choice
        options:
          - default
          - acceptEdits
          - plan
          - bypassPermissions

jobs:
  # Run cleaning process only if workflow is triggered by the non-"claude-starter-kit" repository.
  template-cleanup:
    name: Template Cleanup
    runs-on: ubuntu-latest
    if: github.event.repository.name != 'claude-starter-kit'
    permissions:
      contents: write
    steps:
      # Check out current repository
      - name: Fetch Sources
        uses: actions/checkout@v4

      # Cleanup project
      - name: Cleanup
        run: |
          export LC_CTYPE=C
          export LANG=C

          # Prepare repository-specific variables
          NAME="${GITHUB_REPOSITORY##*/}"
          ACTOR=$(echo $GITHUB_ACTOR | tr '[:upper:]' '[:lower:]')
          REPOSITORY="${GITHUB_REPOSITORY}"
          SAFE_NAME=$(echo $NAME | sed 's/[^a-zA-Z0-9]//g' | tr '[:upper:]' '[:lower:]')
          SAFE_ACTOR=$(echo $ACTOR | sed 's/[^a-zA-Z0-9]//g' | tr '[:upper:]' '[:lower:]')
          GROUP="com.github.$SAFE_ACTOR.$SAFE_NAME"

          # Get MCP configuration variables from workflow inputs
          LANGUAGE="${{ github.event.inputs.LANGUAGE }}"
          SERENA_INITIAL_PROMPT="${{ github.event.inputs.SERENA_INITIAL_PROMPT }}"
          TM_CUSTOM_SYSTEM_PROMPT="${{ github.event.inputs.TM_CUSTOM_SYSTEM_PROMPT }}"
          TM_APPEND_SYSTEM_PROMPT="${{ github.event.inputs.TM_APPEND_SYSTEM_PROMPT }}"
          TM_PERMISSION_MODE="${{ github.event.inputs.TM_PERMISSION_MODE }}"

          # Replace placeholders in the template files
          find .github/templates -type f -exec sed -i "s/%ACTOR%/$ACTOR/g" {} +
          find .github/templates -type f -exec sed -i "s/%NAME%/$NAME/g" {} +
          find .github/templates -type f -exec sed -i "s/%REPOSITORY%/${GITHUB_REPOSITORY/\//\\/}/g" {} +
          find .github/templates -type f -exec sed -i "s/%GROUP%/$GROUP/g" {} +
          find .github/templates -type f -exec sed -i "s/%SAFE_NAME%/$SAFE_NAME/g" {} +
          find .github/templates -type f -exec sed -i "s/%SAFE_ACTOR%/$SAFE_ACTOR/g" {} +
          find .github/templates -type f -exec sed -i "s/%LANGUAGE%/$LANGUAGE/g" {} +
          find .github/templates -type f -exec sed -i "s/%SERENA_INITIAL_PROMPT%/$SERENA_INITIAL_PROMPT/g" {} +
          find .github/templates -type f -exec sed -i "s/%TM_CUSTOM_SYSTEM_PROMPT%/$TM_CUSTOM_SYSTEM_PROMPT/g" {} +
          find .github/templates -type f -exec sed -i "s/%TM_APPEND_SYSTEM_PROMPT%/$TM_APPEND_SYSTEM_PROMPT/g" {} +
          find .github/templates -type f -exec sed -i "s/%TM_PERMISSION_MODE%/$TM_PERMISSION_MODE/g" {} +

          rm -rf .claude .serena .taskmaster

          # Deploy templates to destination locations
          cp -r .github/templates/claude ./.claude
          cp -r .github/templates/serena ./.serena
          cp -r .github/templates/taskmaster ./.taskmaster
          cp .github/templates/bootstrap.sh .

          # Complete cleanup - remove everything except preserved files/directories
          # Preserve: .git/, .gitignore, .serena/, .taskmaster/, .claude/
          find . -mindepth 1 -maxdepth 1 \
            ! -name '.git' \
            ! -name '.gitignore' \
            ! -name '.claude' \
            ! -name '.serena' \
            ! -name '.taskmaster' \
            ! -name 'bootstrap.sh' \
            -exec rm -rf {} +

          # Generate minimal README
          echo "# $NAME" > README.md

      # Commit modified files
      - name: Commit files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Template cleanup"

      # Push changes
      - name: Push changes
        run: |-
          BRANCH=$(git branch --show-current)
          git push origin $BRANCH
